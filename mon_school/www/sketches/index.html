{% extends "templates/base.html" %}
{% from "www/macros/livecode.html" import LiveCodeEditor, LiveCodeEditorJS %}
{% from "www/macros/sketch_card.html" import sketch_card %}

{% block title %}Sketches{% endblock %}
{% block head_include %}
<meta name="description" content="Sketches" />
<meta name="keywords" content="sketches" />
<link rel="stylesheet" href="/assets/css/lms.css">
{% endblock %}

{% block content %}
<div class="common-page-style">
  <div class='container'>
    <div class="sketch-page-header">
      <span class="course-home-headings">Sketches</span>
      <a href="/sketches/new" class="btn btn-primary pull-right">Submit a Sketch</a>
    </div>
    <div class="card-divider-dark"></div>
    <div class="sketch-list">
      {% for sketch in sketches %}
      {{ sketch_card(sketch, True, widgets) }}
      {% endfor %}
    </div>
    <div class="mt-5">
      {{ Paginate(page, num_pages) }}
    </div>
  </div>
</div>
{% endblock %}

{% macro Paginate(page, num_pages) %}
<nav aria-label="Page navigation">
  <ul class="pagination justify-content-center">
    <li class="page-item {{'disabled' if page==1 else ''}}">
      <a class="page-link" href="/sketches?page={{page-1}}" aria-label="Previous">
        <span aria-hidden="true">&lsaquo; Previous</span>
        <span class="sr-only">Previous</span>
      </a>
    </li>
    {% for i in range(page_range_start, page_range_end) %}
      <li class="page-item {{'disabled' if i==page else ''}}">
        <a class="page-link" href="/sketches?page={{i}}">{{i}}</a>
      </li>
    {% endfor %}
    <li class="page-item {{'disabled' if page==num_pages else ''}}">
      <a class="page-link" href="/sketches?page={{page+1}}" aria-label="Next">
        <span aria-hidden="true">Next &rsaquo;</span>
        <span class="sr-only">Next</span>
      </a>
    </li>
  </ul>
</nav>
{% endmacro %}

{% block script %}

  <script type="text/javascript">
    var notLikedLikeIconSrc = "/assets/school/icons/like.svg";
    var likedLikeIconSrc = "/assets/mon_school/icons/red-like.svg";

    function toggleLike($btn) {
      if (!frappe.user_id && (!frappe.user || !frappe.user.name)) {
        // show alert for unauthenticated user
        frappe.show_alert({
          message: "Please login to like a sketch",
          indicator: "yellow",
        }, 5);
        return;
      }

      var sketchName = $btn.attr("data-sketch-name");
      var action = $btn.hasClass("not-liked") ? "like" : "unlike";

      frappe.call({
        method: "mon_school.mon_school.doctype.lms_sketch_like.lms_sketch_like.toggle_sketch_like",
        args: {
          sketch_name: sketchName,
          action: action,
        },
        btn: $btn, // disables button until a response is received
      })
      .then(r => {
        if (r.ok) {
          $likeIcon = $btn.find(".like-icon");
          $likeCount = $btn.find("#like-count");

          if (action == "like") {
            $btn.removeClass("not-liked").addClass("liked");
            $likeIcon.attr("src", likedLikeIconSrc);
            $likeCount.text(parseInt($likeCount.text()) + 1);
          } else if (action == "unlike") {
            $btn.removeClass("liked").addClass("not-liked");
            $likeIcon.attr("src", notLikedLikeIconSrc);
            $btn.find("#like-count")
            $likeCount.text(parseInt($likeCount.text()) - 1);
          }
        } else {
          var error = r.error;
          // log to console for now
          console.error(error);
        }
      });
    }

    $(document).ready(function(){
      $(".like-button").click(function(){
        toggleLike($(this));
      })
    });

  </script>

{% endblock %}
