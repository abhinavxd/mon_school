{% extends "templates/base.html" %}

{% block title %}{{contest.name}} - Submitted Entries{% endblock %}
{% block head_include %}
	<meta name="description" content="{{ contest.name }} - submitted entries" />
	<meta name="keywords" content="contest {{contest.name}}" />
{% endblock %}

{% block content %}
<section class="top-section" style="padding: 1rem 0rem;">
	<div class='container pb-5'>
    <div class="sketch-header">
      <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
          <li class="breadcrumb-item" aria-current="page"><a href="/{{contest.name}}">{{contest.title}}</a></li>
        </ol>
      </nav>
      <h1 class="sketch-title">Review Submissions</h1>

      <ul class="nav nav-tabs">
        <li class="nav-item">
          <a class="nav-link {{'active' if tab=='bookmarks' }}" href="/{{contest.name}}/review?tab=bookmarks">Your Bookmarks <span class="badge badge-primary" id="bookmark-count">{{bookmarks | length}}</span></a>
        </li>
        <li class="nav-item">
          <a class="nav-link {{'active' if tab=='all' }}" href="/{{contest.name}}/review?tab=all">All Submissions</a>
        </li>
      </ul>
      <div class='container'>
      {% if tab == "bookmarks" %}
        {{ TabBookmarks() }}
      {% else %}
        {{ TabAll() }}
      {% endif %}
      </div>
    </div>
  </div>
</section>
{% endblock %}

{% macro TabAll() %}
    <div class="mt-5">
      <p>Showing page {{page}} of {{num_pages}}</p>
    </div>
    <div class="row">
      {% for sketch in entries %}
        <div class="col-md-3">
          <div class="sketch-teaser">
            <div class="sketch-image">
              <a href="/{{contest.name}}/submissions/{{sketch.name}}">
                <img src="{{sketch.get_image_url()}}" />
              </a>
            </div>
            <div class="sketch-footer">
              <div class="sketch-author">
                {% set owner = sketch.get_owner() %}
                <div class="pull-right">
                  <svg class="icon icon-sm {{'liked' if sketch.name in likes}}"  style="width: 16px; height: 16px;">
                    <use href="#icon-heart" class="like-icon" data-entry="{{sketch.name}}"></use>
                  </svg>
                </div>
                <a href="/{{owner.username}}">{{owner.full_name | e}}</a>
              </div>
            </div>
          </div>
        </div>
      {% endfor %}
    </div>

    {{ Paginate(page, num_pages) }}

{% endmacro %}

{% macro TabBookmarks() %}
    <div class="mt-5">
      <p>Showing <span id="xbookmark-count">{{ bookmarks | length }}</span> entries bookmarked by you.</p>
    </div>
    <div class="row">
      {% for sketch in bookmarks %}
        <div class="col-md-3 sketch-container">
          <div class="sketch-teaser">
            <div class="sketch-image">
              <a href="/{{contest.name}}/submissions/{{sketch.name}}">
                <img src="{{sketch.get_image_url()}}" />
              </a>
            </div>
            <div class="sketch-footer">
              <div class="sketch-author">
                {% set owner = sketch.get_owner() %}
                <div class="pull-right">
                  <svg class="icon icon-sm {{'liked' if sketch.name in likes}}"  style="width: 16px; height: 16px;">
                    <use href="#icon-heart" class="like-icon" data-entry="{{sketch.name}}"></use>
                  </svg>
                </div>
                <a href="/{{owner.username}}">{{owner.full_name | e}}</a>
              </div>
            </div>
          </div>
        </div>
      {% endfor %}
    </div>

{% endmacro %}


{% macro Paginate(page, num_pages) %}
<nav aria-label="Page navigation example">
  <ul class="pagination">
    <li class="page-item {{'disabled' if page==1 else ''}}">
      <a class="page-link" href="/{{contest.name}}/review?page={{page-1}}" aria-label="Previous">
        <span aria-hidden="true">&laquo;</span>
        <span class="sr-only">Previous</span>
      </a>
    </li>
    {% for i in range(1, num_pages+1) %}
      <li class="page-item {{'disabled' if i==page else ''}}">
        <a class="page-link" href="/{{contest.name}}/review?page={{i}}">{{i}}</a>
      </li>
    {% endfor %}
    <li class="page-item {{'disabled' if page==num_pages else ''}}">
      <a class="page-link" href="/{{contest.name}}/review?page={{page+1}}" aria-label="Next">
        <span aria-hidden="true">&raquo;</span>
        <span class="sr-only">Next</span>
      </a>
    </li>
  </ul>
</nav>
{% endmacro %}


{%- block script %}
{{ super() }}
<script type="text/javascript">
  var likes = {{ likes | tojson }};
  var tab = "{{ tab }}";

  function updateBookmarkCount() {
    var n = Object.keys(likes).length;
    $("#bookmark-count").html(n);
  }

  $(function() {
    $(".like-icon").click(function() {
      var method;
      var action;
      var entry = $(this).data("entry");
      var _this = this;
      $(this).parent().toggleClass("liked");
      if ($(this).parent().hasClass("liked")) {
        method = "mon_school.mon_school.doctype.contest.contest.add_bookmark";
        action = "add";
      }
      else {
        method = "mon_school.mon_school.doctype.contest.contest.delete_bookmark";
        action = "delete";
      }
      frappe.call(method, {
        "entry": entry
      }).then((data) => {
        if (action=="delete") {
          if (tab == "bookmarks") {
            $(this).closest(".sketch-container").remove();
          }
          delete likes[entry];
        }
        else {
          likes[entry] = true;
        }
        updateBookmarkCount()
      })
    })
  });
</script>
{%- endblock %}
